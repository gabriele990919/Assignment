<!DOCTYPE html>
<html lang="lt">
<head>
<meta charset="UTF-8">
<title>Sąskaita Faktūra</title>
<style>
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  input { width: 60px; }
  button { margin: 5px 0; }
</style>
</head>
<body>

<h1 id="pageTitle">Sukurti naują sąskaitą</h1>

<form id="invoiceForm">
  Numeris: <input type="text" id="number" required><br><br>
  Data: <input type="date" id="date" required><br><br>

  <button type="button" onclick="addItem()">Pridėti prekę ranka</button>
  <button type="button" onclick="loadFromAPI()">Užkrauti prekes iš API</button>

  <table id="itemsTable">
    <thead>
      <tr><th>Prekė</th><th>Kiekis</th><th>Kaina</th><th>Nuolaida</th></tr>
    </thead>
    <tbody></tbody>
  </table><br>

  <strong>PVM:</strong> <span id="vat">0</span> €<br>
  <strong>Galutinė suma:</strong> <span id="total">0</span> €<br><br>

  <button type="submit">Išsaugoti sąskaitą</button>
</form>

<script>
let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
let urlParams = new URLSearchParams(window.location.search);
let invoiceId = urlParams.get('id');
let viewMode = urlParams.get('view') === 'true';
let currentInvoice = invoiceId ? invoices.find(inv => inv.id === invoiceId) : null;

// Normalizuoja bet kokį item į paprastą formą
function normalizeItem(item) {
  return {
    name: typeof item.name === 'string' ? item.name : (item.product?.name ?? JSON.stringify(item.name ?? '')),
    qty: !isNaN(Number(item.qty)) ? Number(item.qty) : 1,
    price: !isNaN(Number(item.price)) ? Number(item.price) : 0,
    discount: !isNaN(Number(item.discount)) ? Number(item.discount) : 0
  };
}

// Prideda prekę į lentelę
function addItem(item = {name:'', qty:1, price:0, discount:0}) {
  const tbody = document.querySelector('#itemsTable tbody');
  const tr = document.createElement('tr');

  const name = typeof item.name === 'string' ? item.name : JSON.stringify(item.name ?? '');
  const qty = !isNaN(Number(item.qty)) ? Number(item.qty) : 1;
  const price = !isNaN(Number(item.price)) ? Number(item.price) : 0;
  const discount = !isNaN(Number(item.discount)) ? Number(item.discount) : 0;

  tr.innerHTML = `
    <td><input type="text" value="${name}" ${viewMode ? 'disabled' : ''}></td>
    <td><input type="number" value="${qty}" ${viewMode ? 'disabled' : ''}></td>
    <td><input type="number" value="${price}" ${viewMode ? 'disabled' : ''}></td>
    <td><input type="number" value="${discount}" ${viewMode ? 'disabled' : ''}></td>
  `;
  tbody.appendChild(tr);
  updateTotals();

  if (!viewMode) {
    tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', updateTotals));
  }
}

// Apskaičiuoja PVM ir galutinę sumą
function updateTotals() {
  const rows = document.querySelectorAll('#itemsTable tbody tr');
  let total = 0;
  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const qty = Number(inputs[1].value) || 0;
    const price = Number(inputs[2].value) || 0;
    const discount = Number(inputs[3].value) || 0;
    total += qty * price - discount;
  });
  const vat = total * 0.21;
  document.getElementById('vat').textContent = vat.toFixed(2);
  document.getElementById('total').textContent = (total + vat).toFixed(2);
}

// Užkrauna prekes iš API
function loadFromAPI() {
  fetch('https://in3.dev/inv/') // pakeisk į konkretų endpoint
    .then(res => res.json())
    .then(data => {
      let items = [];
      if (Array.isArray(data)) {
        items = data.map(normalizeItem);
      } else if (data.items && Array.isArray(data.items)) {
        items = data.items.map(normalizeItem);
      } else {
        console.error('API struktūra neatitinka lūkesčių:', data);
        return;
      }

      document.querySelector('#itemsTable tbody').innerHTML = '';
      items.forEach(item => addItem(item));
      updateTotals();
    })
    .catch(err => console.error('Klaida kraunant API:', err));
}

// Išsaugo sąskaitą
function saveInvoice(e) {
  e.preventDefault();
  if (viewMode) return;

  const number = document.getElementById('number').value;
  const date = document.getElementById('date').value;
  const items = Array.from(document.querySelectorAll('#itemsTable tbody tr')).map(row => {
    const inputs = row.querySelectorAll('input');
    return {
      name: inputs[0].value,
      qty: Number(inputs[1].value) || 1,
      price: Number(inputs[2].value) || 0,
      discount: Number(inputs[3].value) || 0
    };
  });

  const total = Number(document.getElementById('total').textContent) || 0;
  const vat = Number(document.getElementById('vat').textContent) || 0;

  if (currentInvoice) {
    currentInvoice.number = number;
    currentInvoice.date = date;
    currentInvoice.items = items;
    currentInvoice.total = total;
    currentInvoice.vat = vat;
  } else {
    invoices.push({
      id: Date.now().toString(),
      number,
      date,
      items,
      total,
      vat
    });
  }

  localStorage.setItem('invoices', JSON.stringify(invoices));
  window.location = 'index.html';
}

document.getElementById('invoiceForm').addEventListener('submit', saveInvoice);

// Užpildo laukus jei redaguojama arba žiūrima
if (currentInvoice) {
  document.getElementById('number').value = currentInvoice.number;
  document.getElementById('date').value = currentInvoice.date;
  currentInvoice.items.forEach(item => addItem(normalizeItem(item)));
  document.getElementById('pageTitle').textContent = viewMode ? 'Peržiūra sąskaita' : 'Redaguoti sąskaitą';
} else {
  addItem(); // nauja sąskaita pradedama su viena preke
}

// Automatinis numerio sugeneravimas
if (!currentInvoice) {
  document.getElementById('number').value = `SF-${Date.now()}`;
  document.getElementById('date').valueAsDate = new Date();
}
</script>

</body>
</html>
    